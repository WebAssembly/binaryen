;; NOTE: Assertions have been generated by update_lit_checks.py --all-items and should not be edited.
;; RUN: wasm-ctor-eval %s --ctors=new,nop --kept-exports=new,nop --quiet -all -S -o - | filecheck %s

;; We can eval $new, and afterwards also eval $nop as well. When doing the
;; latter we should not undo or break the previous work in any way. In
;; particular, we should have a valid global for $new to refer to (which
;; contains the serialization of the struct.new instruction).

(module
 ;; CHECK:      (type $A (struct ))
 (type $A (struct))

 ;; CHECK:      (type $none_=>_ref|any| (func (result (ref any))))

 ;; CHECK:      (type $none_=>_none (func))

 ;; CHECK:      (global $ctor-eval$global (ref $A) (struct.new_default $A))

 ;; CHECK:      (export "new" (func $new_0))
 (export "new" (func $new))
 ;; CHECK:      (export "nop" (func $nop_0))
 (export "nop" (func $nop))

 (func $new (result (ref any))
  (struct.new $A)
 )

 (func $nop
  (nop)
 )
)
;; CHECK:      (func $new_0 (type $none_=>_ref|any|) (result (ref any))
;; CHECK-NEXT:  (global.get $ctor-eval$global)
;; CHECK-NEXT: )

;; CHECK:      (func $nop_0 (type $none_=>_none)
;; CHECK-NEXT:  (nop)
;; CHECK-NEXT: )
