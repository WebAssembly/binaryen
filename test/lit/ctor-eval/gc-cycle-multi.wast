;; NOTE: Assertions have been generated by update_lit_checks.py --all-items and should not be edited.
;; RUN: foreach %s %t wasm-ctor-eval --ctors=test1,test2,test3 --kept-exports=test1,test2,test3 --quiet -all -S -o - | filecheck %s

;; Similar to gc-cycle.wast, but now there are three exported ctors that we
;; call.

(module
 ;; Multiple independent cycles.
 (type $A (struct (field (mut (ref null $A))) (field i32)))

 (global $a (mut (ref null $A)) (ref.null $A))
 (global $b (mut (ref null $A)) (ref.null $A))
 (global $c (mut (ref null $A)) (ref.null $A))

 (func $makeCycle (result (ref $A))
  (local $x (ref $A))
  (local.set $x
   (struct.new $A
    (ref.null $A)
    (i32.const 42)
   )
  )
  (struct.set $A 0
   (local.get $x)
   (local.get $x)
  )
  (local.get $x)
 )

 (func "test1"
  (global.set $a
   (call $makeCycle)
  )
 )

 (func "test2"
  (global.set $b
   (call $makeCycle)
  )
 )

 (func "test3"
  (global.set $c
   (call $makeCycle)
  )
 )

 (func "keepalive"
  (drop
   (global.get $a)
  )
  (drop
   (global.get $b)
  )
  (drop
   (global.get $c)
  )
 )
)
