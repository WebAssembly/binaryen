;; NOTE: Assertions have been generated by update_lit_checks.py --all-items and should not be edited.

;; Get references to both functions from both modules, and ensure they are
;; exact. Test in both custom descriptors mode, and without (without, we do not
;; add a cast).

;; RUN: wasm-split -all -g %s --keep-funcs=foo -o1 %t.1.wasm -o2 %t.2.wasm
;; RUN: wasm-opt   -all %t.1.wasm --print | filecheck %s --check-prefix=PRIMARY
;; RUN: wasm-opt   -all %t.2.wasm --print | filecheck %s --check-prefix=SECONDARY

;; RUN: wasm-split -all --disable-custom-descriptors -g %s --keep-funcs=foo -o1 %t.1.wasm -o2 %t.2.wasm
;; RUN: wasm-opt   -all --disable-custom-descriptors %t.1.wasm --print | filecheck %s --check-prefix=PRIMARY_NOCD
;; RUN: wasm-opt   -all --disable-custom-descriptors %t.2.wasm --print | filecheck %s --check-prefix=SECONDARY_NOCD

(module
 ;; PRIMARY:      (type $func (sub (func)))
 ;; PRIMARY_NOCD:      (type $func (sub (func)))
 (type $func (sub (func)))

 ;; PRIMARY:      (import "placeholder.deferred" "0" (func $placeholder_0 (type $func)))

 ;; PRIMARY:      (table $0 1 funcref)

 ;; PRIMARY:      (elem $0 (i32.const 0) $placeholder_0)

 ;; PRIMARY:      (elem declare func $foo $trampoline_bar)

 ;; PRIMARY:      (export "foo" (func $foo))

 ;; PRIMARY:      (export "table" (table $0))

 ;; PRIMARY:      (func $foo (type $func)
 ;; PRIMARY-NEXT:  (local $exact (ref (exact $func)))
 ;; PRIMARY-NEXT:  (local.set $exact
 ;; PRIMARY-NEXT:   (ref.func $foo)
 ;; PRIMARY-NEXT:  )
 ;; PRIMARY-NEXT:  (local.set $exact
 ;; PRIMARY-NEXT:   (ref.func $trampoline_bar)
 ;; PRIMARY-NEXT:  )
 ;; PRIMARY-NEXT: )
 ;; PRIMARY_NOCD:      (import "placeholder.deferred" "0" (func $placeholder_0 (type $func)))

 ;; PRIMARY_NOCD:      (table $0 1 funcref)

 ;; PRIMARY_NOCD:      (elem $0 (i32.const 0) $placeholder_0)

 ;; PRIMARY_NOCD:      (elem declare func $foo $trampoline_bar)

 ;; PRIMARY_NOCD:      (export "foo" (func $foo))

 ;; PRIMARY_NOCD:      (export "table" (table $0))

 ;; PRIMARY_NOCD:      (func $foo (type $func)
 ;; PRIMARY_NOCD-NEXT:  (local $exact (ref $func))
 ;; PRIMARY_NOCD-NEXT:  (local.set $exact
 ;; PRIMARY_NOCD-NEXT:   (ref.func $foo)
 ;; PRIMARY_NOCD-NEXT:  )
 ;; PRIMARY_NOCD-NEXT:  (local.set $exact
 ;; PRIMARY_NOCD-NEXT:   (ref.func $trampoline_bar)
 ;; PRIMARY_NOCD-NEXT:  )
 ;; PRIMARY_NOCD-NEXT: )
 (func $foo (type $func)
  (local $exact (ref (exact $func)))
  (local.set $exact
   (ref.func $foo)
  )
  (local.set $exact
   (ref.func $bar)
  )
 )

 ;; SECONDARY:      (type $0 (sub (func)))

 ;; SECONDARY:      (import "primary" "table" (table $timport$0 1 funcref))

 ;; SECONDARY:      (import "primary" "foo" (func $foo (type $0)))

 ;; SECONDARY:      (elem $0 (i32.const 0) $bar)

 ;; SECONDARY:      (elem declare func $foo)

 ;; SECONDARY:      (func $bar (type $0)
 ;; SECONDARY-NEXT:  (local $exact (ref (exact $0)))
 ;; SECONDARY-NEXT:  (local.set $exact
 ;; SECONDARY-NEXT:   (ref.cast (ref (exact $0))
 ;; SECONDARY-NEXT:    (ref.func $foo)
 ;; SECONDARY-NEXT:   )
 ;; SECONDARY-NEXT:  )
 ;; SECONDARY-NEXT:  (local.set $exact
 ;; SECONDARY-NEXT:   (ref.func $bar)
 ;; SECONDARY-NEXT:  )
 ;; SECONDARY-NEXT: )
 ;; SECONDARY_NOCD:      (type $0 (sub (func)))

 ;; SECONDARY_NOCD:      (import "primary" "table" (table $timport$0 1 funcref))

 ;; SECONDARY_NOCD:      (import "primary" "foo" (func $foo (type $0)))

 ;; SECONDARY_NOCD:      (elem $0 (i32.const 0) $bar)

 ;; SECONDARY_NOCD:      (elem declare func $foo)

 ;; SECONDARY_NOCD:      (func $bar (type $0)
 ;; SECONDARY_NOCD-NEXT:  (local $exact (ref $0))
 ;; SECONDARY_NOCD-NEXT:  (local.set $exact
 ;; SECONDARY_NOCD-NEXT:   (ref.func $foo)
 ;; SECONDARY_NOCD-NEXT:  )
 ;; SECONDARY_NOCD-NEXT:  (local.set $exact
 ;; SECONDARY_NOCD-NEXT:   (ref.func $bar)
 ;; SECONDARY_NOCD-NEXT:  )
 ;; SECONDARY_NOCD-NEXT: )
 (func $bar (type $func)
  (local $exact (ref (exact $func)))
  (local.set $exact
   (ref.func $foo)
  )
  (local.set $exact
   (ref.func $bar)
  )
 )
)
;; PRIMARY:      (func $trampoline_bar (type $func)
;; PRIMARY-NEXT:  (call_indirect $0 (type $func)
;; PRIMARY-NEXT:   (i32.const 0)
;; PRIMARY-NEXT:  )
;; PRIMARY-NEXT: )

;; PRIMARY_NOCD:      (func $trampoline_bar (type $func)
;; PRIMARY_NOCD-NEXT:  (call_indirect $0 (type $func)
;; PRIMARY_NOCD-NEXT:   (i32.const 0)
;; PRIMARY_NOCD-NEXT:  )
;; PRIMARY_NOCD-NEXT: )
