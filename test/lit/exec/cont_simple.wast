;; NOTE: Assertions have been generated by update_lit_checks.py --output=fuzz-exec and should not be edited.

;; RUN: wasm-opt %s -all --fuzz-exec-before -q -o /dev/null 2>&1 | filecheck %s

;; A coroutine with only control flow in a single basic block (no locals, no
;; params, no branching, no value stack).
(module $state
  (type $f (func))
  (type $k (cont $f))

  (import "fuzzing-support" "log" (func $log (param i32)))

  (tag $more)

  (func $run (export "run")
    (local $k (ref $k))
    (local.set $k
      (cont.new $k (ref.func $f))
    )
    (call $log (i32.const 100))
    (loop $loop
      (block $on (result (ref $k))
        (resume $k (on $more $on)
          (local.get $k)
        )
        (call $log (i32.const 200))
        (return)
      )
      ;; on
      (call $log (i32.const 300))
      (local.set $k)
      (br $loop)
    )
    (unreachable)
  )

  (func $f
    (call $log (i32.const -1))
    (suspend $more)
    (call $log (i32.const -2))
    (suspend $more)
    (call $log (i32.const -3))
  )
)

