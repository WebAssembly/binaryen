;; NOTE: Assertions have been generated by update_lit_checks.py --all-items and should not be edited.

;; RUN: foreach %s %t wasm-opt --remove-unused-module-elements --all-features -S -o - | filecheck %s

;; Test for precise handling of call_indirect types.

;; We have an indirect call of $A, but not of $B. This keeps alive segments with
;; relevant functions, but not other segments. It also does not keep alive other
;; functions in those segments (we refer to them, but can empty out their
;; contents).
(module
 (type $A (func))

 (type $B (func (param f64)))

 (type $subA (sub $A (func)))

 (table $t1 6 6 funcref)

 (table $t2 6 6 funcref)

 (elem $t1-e1 (table $t1) (i32.const 0) func $A1 $B1 $subA1 $C1)

 (func $export (export "export")
  (drop
   (call_indirect $t1 (type $0)
    (f64.const 1)
    (i32.const -1)
   )
  )
 )

 (func $A1 (type $A)
  (drop (i32.const 10))
 )

 (func $B1 (type $A) (param $p f64)
  (drop (i32.const 20))
 )

 (func $subA1 (type $subA)
  (drop (i32.const 30))
 )

 (func $C (param $p f32)
  (drop (i32.const 40))
 )
)
