;; NOTE: Assertions have been generated by update_lit_checks.py --all-items and should not be edited.
;; RUN: foreach %s %t wasm-opt --once-reduction -all -S -o - | filecheck %s

(module
  (import "a" "b" (func $import))

  @binaryen.idempotent
  (func $idempotent
    ;; This function has side effects, but is marked idempotent.
    (call $import)
  )

  (func $potent
    ;; As above, but not marked as idempotent.
    (call $import)
  )

  (func $basics
    ;; We can optimize here, using idempotency.
    (call $idempotent)
    (call $idempotent)

    ;; We can't optimize here.
    (call $potent)
    (call $potent)
  )

  @binaryen.idempotent
  (func $idempotent2
    ;; A second idempotent function.
    (call $import)
  )

  (func $mix
    ;; We can't optimize here: these are idempotent, but different.
    (call $idempotent)
    (call $idempotent2)
  )

  (func $mix2
    ;; As above, reverse order. We can't optimize here.
    (call $idempotent)
    (call $idempotent2)
  )

  (func $mix3
    (call $idempotent)
    (call $idempotent2)

    ;; We can remove both of these second calls.
    (call $idempotent)
    (call $idempotent2)

    ;; These two, which are reordered.
    (call $idempotent2)
    (call $idempotent)
  )
)

(module
  (import "a" "b" (func $import))

  @binaryen.idempotent
  (func $idempotent (param $x i32)
    ;; As above, but now with a param.
    (call $import)
  )

  (func $basics
    ;; We could optimize here in theory, but the pass does not track params
    ;; yet. It could compare them for equality, check generativity, etc.
    (call $idempotent (i32.const 10))
    (call $idempotent (i32.const 10))
  )
)

(module
  (import "a" "b" (func $import))

  @binaryen.idempotent
  (func $idempotent (result i32)
    ;; As above, but now with a result.
    (call $import)
    (i32.const 42)
  )

  (func $basics
    ;; We could optimize here in theory, but the pass does not track results
    ;; yet.
    (drop
      (call $idempotent)
    )
    (drop
      (call $idempotent)
    )
  )
)
