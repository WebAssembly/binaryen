;; NOTE: Assertions have been generated by update_lit_checks.py --all-items and should not be edited.

;; RUN: foreach %s %t wasm-opt --enclose-world -all -S -o - | filecheck %s

(module
  (type $A (struct))
  (type $B (struct (field i32)))
  (type $C (struct (field i32 f64)))

  (func $normal (export "normal") (param $x i32) (result f64)
    ;; A normal function which we do not need to do anything with.
    (f64.const 3.14159)
  )

  (func $externref-param (export "externref-param") (param $x externref)
    ;; An externref param is fine, we don't need to do anything.
  )

  (func $externref-result (export "externref-result") (result externref)
    ;; An externref result is also fine.
    (unreachable)
  )

  (func $anyref-param (export "anyref-param") (param $x anyref)
    ;; An anyref requires a fixup. We will call this from a stub that has an
    ;; externref param, which calls this.
  )

  (func $anyref-result (export "anyref-result") (result anyref)
    ;; An anyref result also requires a fixup.
    (unreachable)
  )

  (func $anyref-both (export "anyref-both") (param $x anyref) (result anyref)
    ;; Here we must fix up both the param and the result.
    (unreachable)
  )

  (func $anyref-both-dupe (export "anyref-both-dupe") (param $x anyref) (result anyref)
    ;; Here we must fix up both the param and the result.
    (unreachable)
  )

  (func $many (export "many") (param $a (ref $A)) (param $b (ref null $B)) (result (ref $C))
    ;; Various declared types are used, and must be fixed up.
    (unreachable)
  )
)

;; Export a function that needs fixups twice. We should reuse a single stub.
(module
  (export "a" (func $anyref-both))

  (export "b" (func $anyref-both))

  (func $anyref-both (param $x anyref) (result anyref)
    (unreachable)
  )
)
