;; NOTE: Assertions have been generated by update_lit_checks.py
;; RUN: wasm-opt %s --all-features --optimize-level=2 --ignore-implicit-traps -S -o - \
;; RUN:   | filecheck %s

(module
  (type $0 (func (param i32 i32) (result i32)))
  (memory $0 0)
 ;; CHECK: (func $conditionals (param $0 i32) (param $1 i32) (result i32)
 ;; CHECK:  (local $2 i32)
 ;; CHECK:  (local $3 i32)
 ;; CHECK:  (local $4 i32)
 ;; CHECK:  (local $5 i32)
 ;; CHECK:  (local $6 i32)
 ;; CHECK:  (local $7 i32)
 ;; CHECK:  (local.set $0
 ;; CHECK:   (i32.const 0)
 ;; CHECK:  )
 ;; CHECK:  (loop $while-in
 ;; CHECK:   (local.set $3
 ;; CHECK:    (i32.const 0)
 ;; CHECK:   )
 ;; CHECK:   (loop $while-in6
 ;; CHECK:    (local.set $6
 ;; CHECK:     (i32.add
 ;; CHECK:      (local.get $0)
 ;; CHECK:      (i32.const 1)
 ;; CHECK:     )
 ;; CHECK:    )
 ;; CHECK:    (local.set $0
 ;; CHECK:     (if (result i32)
 ;; CHECK:      (i32.or
 ;; CHECK:       (i32.eqz
 ;; CHECK:        (i32.rem_s
 ;; CHECK:         (i32.add
 ;; CHECK:          (i32.mul
 ;; CHECK:           (local.tee $7
 ;; CHECK:            (i32.add
 ;; CHECK:             (local.get $0)
 ;; CHECK:             (i32.const 2)
 ;; CHECK:            )
 ;; CHECK:           )
 ;; CHECK:           (local.get $0)
 ;; CHECK:          )
 ;; CHECK:          (i32.const 17)
 ;; CHECK:         )
 ;; CHECK:         (i32.const 5)
 ;; CHECK:        )
 ;; CHECK:       )
 ;; CHECK:       (i32.eqz
 ;; CHECK:        (i32.rem_u
 ;; CHECK:         (i32.add
 ;; CHECK:          (i32.mul
 ;; CHECK:           (local.get $0)
 ;; CHECK:           (local.get $0)
 ;; CHECK:          )
 ;; CHECK:          (i32.const 11)
 ;; CHECK:         )
 ;; CHECK:         (i32.const 3)
 ;; CHECK:        )
 ;; CHECK:       )
 ;; CHECK:      )
 ;; CHECK:      (local.get $7)
 ;; CHECK:      (local.get $6)
 ;; CHECK:     )
 ;; CHECK:    )
 ;; CHECK:    (br_if $while-in6
 ;; CHECK:     (i32.lt_s
 ;; CHECK:      (local.tee $3
 ;; CHECK:       (i32.add
 ;; CHECK:        (local.get $3)
 ;; CHECK:        (i32.const 1)
 ;; CHECK:       )
 ;; CHECK:      )
 ;; CHECK:      (local.get $4)
 ;; CHECK:     )
 ;; CHECK:    )
 ;; CHECK:   )
 ;; CHECK:   (br_if $while-in
 ;; CHECK:    (i32.ne
 ;; CHECK:     (local.tee $1
 ;; CHECK:      (i32.add
 ;; CHECK:       (local.get $1)
 ;; CHECK:       (i32.const 1)
 ;; CHECK:      )
 ;; CHECK:     )
 ;; CHECK:     (i32.const 27000)
 ;; CHECK:    )
 ;; CHECK:   )
 ;; CHECK:  )
 ;; CHECK:  (return
 ;; CHECK:   (local.get $5)
 ;; CHECK:  )
 ;; CHECK: )
  (func $conditionals (type $0) (param $0 i32) (param $1 i32) (result i32)
    (local $2 i32)
    (local $3 i32)
    (local $4 i32)
    (local $5 i32)
    (local $6 i32)
    (local $7 i32)
    (local.set $0
      (i32.const 0)
    )
    (loop $while-in
      (local.set $3
        (i32.const 0)
      )
      (loop $while-in6
        (local.set $6
          (i32.add
            (local.get $0)
            (i32.const 1)
          )
        )
        (local.set $0
          (if (result i32)
            (i32.or ;; this or is very expensive. we should compute one side, then see if we even need the other
              (i32.eqz
                (i32.rem_s
                  (i32.add
                    (i32.mul
                      (local.tee $7 ;; side effect, so we can't do this one
                        (i32.add
                          (local.get $0)
                          (i32.const 2)
                        )
                      )
                      (local.get $0)
                    )
                    (i32.const 17)
                  )
                  (i32.const 5)
                )
              )
              (i32.eqz
                (i32.rem_u
                  (i32.add
                    (i32.mul
                      (local.get $0)
                      (local.get $0)
                    )
                    (i32.const 11)
                  )
                  (i32.const 3)
                )
              )
            )
            (local.get $7)
            (local.get $6)
          )
        )
        (br_if $while-in6
          (i32.lt_s
            (local.tee $3
              (i32.add
                (local.get $3)
                (i32.const 1)
              )
            )
            (local.get $4)
          )
        )
      )
      (br_if $while-in
        (i32.ne
          (local.tee $1
            (i32.add
              (local.get $1)
              (i32.const 1)
            )
          )
          (i32.const 27000)
        )
      )
    )
    (return
      (local.get $5)
    )
  )
 ;; CHECK: (func $side-effect (param $0 i32) (param $1 i32) (result i32)
 ;; CHECK:  (local $2 i32)
 ;; CHECK:  (local $3 i32)
 ;; CHECK:  (local $4 i32)
 ;; CHECK:  (local $5 i32)
 ;; CHECK:  (local $6 i32)
 ;; CHECK:  (local $7 i32)
 ;; CHECK:  (local.set $0
 ;; CHECK:   (i32.const 0)
 ;; CHECK:  )
 ;; CHECK:  (loop $while-in
 ;; CHECK:   (local.set $3
 ;; CHECK:    (i32.const 0)
 ;; CHECK:   )
 ;; CHECK:   (loop $while-in6
 ;; CHECK:    (local.set $6
 ;; CHECK:     (i32.add
 ;; CHECK:      (local.get $0)
 ;; CHECK:      (i32.const 1)
 ;; CHECK:     )
 ;; CHECK:    )
 ;; CHECK:    (local.set $0
 ;; CHECK:     (if (result i32)
 ;; CHECK:      (i32.or
 ;; CHECK:       (i32.eqz
 ;; CHECK:        (i32.rem_s
 ;; CHECK:         (i32.add
 ;; CHECK:          (i32.mul
 ;; CHECK:           (local.tee $7
 ;; CHECK:            (i32.add
 ;; CHECK:             (local.get $0)
 ;; CHECK:             (i32.const 0)
 ;; CHECK:            )
 ;; CHECK:           )
 ;; CHECK:           (local.get $0)
 ;; CHECK:          )
 ;; CHECK:          (i32.const 17)
 ;; CHECK:         )
 ;; CHECK:         (i32.const 5)
 ;; CHECK:        )
 ;; CHECK:       )
 ;; CHECK:       (i32.eqz
 ;; CHECK:        (i32.rem_u
 ;; CHECK:         (i32.add
 ;; CHECK:          (i32.mul
 ;; CHECK:           (local.get $0)
 ;; CHECK:           (local.get $0)
 ;; CHECK:          )
 ;; CHECK:          (unreachable)
 ;; CHECK:         )
 ;; CHECK:         (i32.const 3)
 ;; CHECK:        )
 ;; CHECK:       )
 ;; CHECK:      )
 ;; CHECK:      (local.get $7)
 ;; CHECK:      (local.get $6)
 ;; CHECK:     )
 ;; CHECK:    )
 ;; CHECK:    (br_if $while-in6
 ;; CHECK:     (i32.lt_s
 ;; CHECK:      (local.tee $3
 ;; CHECK:       (i32.add
 ;; CHECK:        (local.get $3)
 ;; CHECK:        (i32.const 1)
 ;; CHECK:       )
 ;; CHECK:      )
 ;; CHECK:      (local.get $4)
 ;; CHECK:     )
 ;; CHECK:    )
 ;; CHECK:   )
 ;; CHECK:   (br_if $while-in
 ;; CHECK:    (i32.ne
 ;; CHECK:     (local.tee $1
 ;; CHECK:      (i32.add
 ;; CHECK:       (local.get $1)
 ;; CHECK:       (i32.const 1)
 ;; CHECK:      )
 ;; CHECK:     )
 ;; CHECK:     (i32.const 27000)
 ;; CHECK:    )
 ;; CHECK:   )
 ;; CHECK:  )
 ;; CHECK:  (return
 ;; CHECK:   (local.get $5)
 ;; CHECK:  )
 ;; CHECK: )
  (func $side-effect (type $0) (param $0 i32) (param $1 i32) (result i32)
    (local $2 i32)
    (local $3 i32)
    (local $4 i32)
    (local $5 i32)
    (local $6 i32)
    (local $7 i32)
    (local.set $0
      (i32.const 0)
    )
    (loop $while-in
      (local.set $3
        (i32.const 0)
      )
      (loop $while-in6
        (local.set $6
          (i32.add
            (local.get $0)
            (i32.const 1)
          )
        )
        (local.set $0
          (if (result i32)
            (i32.or ;; this or is very expensive, but has a side effect on both sides
              (i32.eqz
                (i32.rem_s
                  (i32.add
                    (i32.mul
                      (local.tee $7
                        (i32.add
                          (local.get $0)
                          (i32.const 0)
                        )
                      )
                      (local.get $0)
                    )
                    (i32.const 17)
                  )
                  (i32.const 5)
                )
              )
              (i32.eqz
                (i32.rem_u
                  (i32.add
                    (i32.mul
                      (local.get $0)
                      (local.get $0)
                    )
                    (unreachable)
                  )
                  (i32.const 3)
                )
              )
            )
            (local.get $7)
            (local.get $6)
          )
        )
        (br_if $while-in6
          (i32.lt_s
            (local.tee $3
              (i32.add
                (local.get $3)
                (i32.const 1)
              )
            )
            (local.get $4)
          )
        )
      )
      (br_if $while-in
        (i32.ne
          (local.tee $1
            (i32.add
              (local.get $1)
              (i32.const 1)
            )
          )
          (i32.const 27000)
        )
      )
    )
    (return
      (local.get $5)
    )
  )
 ;; CHECK: (func $flip (param $0 i32) (param $1 i32) (result i32)
 ;; CHECK:  (local $2 i32)
 ;; CHECK:  (local $3 i32)
 ;; CHECK:  (local $4 i32)
 ;; CHECK:  (local $5 i32)
 ;; CHECK:  (local $6 i32)
 ;; CHECK:  (local $7 i32)
 ;; CHECK:  (local.set $0
 ;; CHECK:   (i32.const 0)
 ;; CHECK:  )
 ;; CHECK:  (loop $while-in
 ;; CHECK:   (local.set $3
 ;; CHECK:    (i32.const 0)
 ;; CHECK:   )
 ;; CHECK:   (loop $while-in6
 ;; CHECK:    (local.set $6
 ;; CHECK:     (i32.add
 ;; CHECK:      (local.get $0)
 ;; CHECK:      (i32.const 1)
 ;; CHECK:     )
 ;; CHECK:    )
 ;; CHECK:    (local.set $0
 ;; CHECK:     (if (result i32)
 ;; CHECK:      (i32.or
 ;; CHECK:       (i32.eqz
 ;; CHECK:        (i32.rem_s
 ;; CHECK:         (i32.add
 ;; CHECK:          (i32.mul
 ;; CHECK:           (i32.eqz
 ;; CHECK:            (i32.add
 ;; CHECK:             (local.get $0)
 ;; CHECK:             (i32.const 0)
 ;; CHECK:            )
 ;; CHECK:           )
 ;; CHECK:           (local.get $0)
 ;; CHECK:          )
 ;; CHECK:          (i32.const 17)
 ;; CHECK:         )
 ;; CHECK:         (i32.const 5)
 ;; CHECK:        )
 ;; CHECK:       )
 ;; CHECK:       (i32.eqz
 ;; CHECK:        (i32.rem_u
 ;; CHECK:         (i32.add
 ;; CHECK:          (i32.mul
 ;; CHECK:           (local.get $0)
 ;; CHECK:           (local.get $0)
 ;; CHECK:          )
 ;; CHECK:          (i32.const 100)
 ;; CHECK:         )
 ;; CHECK:         (i32.const 3)
 ;; CHECK:        )
 ;; CHECK:       )
 ;; CHECK:      )
 ;; CHECK:      (local.get $7)
 ;; CHECK:      (local.get $6)
 ;; CHECK:     )
 ;; CHECK:    )
 ;; CHECK:    (br_if $while-in6
 ;; CHECK:     (i32.lt_s
 ;; CHECK:      (local.tee $3
 ;; CHECK:       (i32.add
 ;; CHECK:        (local.get $3)
 ;; CHECK:        (i32.const 1)
 ;; CHECK:       )
 ;; CHECK:      )
 ;; CHECK:      (local.get $4)
 ;; CHECK:     )
 ;; CHECK:    )
 ;; CHECK:   )
 ;; CHECK:   (br_if $while-in
 ;; CHECK:    (i32.ne
 ;; CHECK:     (local.tee $1
 ;; CHECK:      (i32.add
 ;; CHECK:       (local.get $1)
 ;; CHECK:       (i32.const 1)
 ;; CHECK:      )
 ;; CHECK:     )
 ;; CHECK:     (i32.const 27000)
 ;; CHECK:    )
 ;; CHECK:   )
 ;; CHECK:  )
 ;; CHECK:  (return
 ;; CHECK:   (local.get $5)
 ;; CHECK:  )
 ;; CHECK: )
  (func $flip (type $0) (param $0 i32) (param $1 i32) (result i32)
    (local $2 i32)
    (local $3 i32)
    (local $4 i32)
    (local $5 i32)
    (local $6 i32)
    (local $7 i32)
    (local.set $0
      (i32.const 0)
    )
    (loop $while-in
      (local.set $3
        (i32.const 0)
      )
      (loop $while-in6
        (local.set $6
          (i32.add
            (local.get $0)
            (i32.const 1)
          )
        )
        (local.set $0
          (if (result i32)
            (i32.or ;; this or is very expensive, and the first side has no side effect
              (i32.eqz
                (i32.rem_s
                  (i32.add
                    (i32.mul
                      (i32.eqz
                        (i32.add
                          (local.get $0)
                          (i32.const 0)
                        )
                      )
                      (local.get $0)
                    )
                    (i32.const 17)
                  )
                  (i32.const 5)
                )
              )
              (i32.eqz
                (i32.rem_u
                  (i32.add
                    (i32.mul
                      (local.get $0)
                      (local.get $0)
                    )
                    (i32.const 100)
                  )
                  (i32.const 3)
                )
              )
            )
            (local.get $7)
            (local.get $6)
          )
        )
        (br_if $while-in6
          (i32.lt_s
            (local.tee $3
              (i32.add
                (local.get $3)
                (i32.const 1)
              )
            )
            (local.get $4)
          )
        )
      )
      (br_if $while-in
        (i32.ne
          (local.tee $1
            (i32.add
              (local.get $1)
              (i32.const 1)
            )
          )
          (i32.const 27000)
        )
      )
    )
    (return
      (local.get $5)
    )
  )
 ;; CHECK: (func $invalidate-conditionalizeExpensiveOnBitwise (param $0 i32) (param $1 i32) (result i32)
 ;; CHECK:  (if
 ;; CHECK:   (i32.eqz
 ;; CHECK:    (i32.and
 ;; CHECK:     (i32.lt_s
 ;; CHECK:      (i32.and
 ;; CHECK:       (i32.shr_s
 ;; CHECK:        (i32.shl
 ;; CHECK:         (i32.add
 ;; CHECK:          (local.get $1)
 ;; CHECK:          (i32.const -1)
 ;; CHECK:         )
 ;; CHECK:         (i32.const 24)
 ;; CHECK:        )
 ;; CHECK:        (i32.const 24)
 ;; CHECK:       )
 ;; CHECK:       (i32.const 255)
 ;; CHECK:      )
 ;; CHECK:      (i32.const 3)
 ;; CHECK:     )
 ;; CHECK:     (i32.ne
 ;; CHECK:      (local.tee $1
 ;; CHECK:       (i32.const 0)
 ;; CHECK:      )
 ;; CHECK:      (i32.const 0)
 ;; CHECK:     )
 ;; CHECK:    )
 ;; CHECK:   )
 ;; CHECK:   (return
 ;; CHECK:    (local.get $0)
 ;; CHECK:   )
 ;; CHECK:  )
 ;; CHECK:  (return
 ;; CHECK:   (local.get $1)
 ;; CHECK:  )
 ;; CHECK: )
  (func $invalidate-conditionalizeExpensiveOnBitwise (param $0 i32) (param $1 i32) (result i32)
   (if
    (i32.eqz
     (i32.and
      (i32.lt_s
       (i32.and
        (i32.shr_s
         (i32.shl
          (i32.add
           (local.get $1) ;; conflict with tee
           (i32.const -1)
          )
          (i32.const 24)
         )
         (i32.const 24)
        )
        (i32.const 255)
       )
       (i32.const 3)
      )
      (i32.ne
       (local.tee $1
        (i32.const 0)
       )
       (i32.const 0)
      )
     )
    )
    (return (local.get $0))
   )
   (return (local.get $1))
  )
 ;; CHECK: (func $invalidate-conditionalizeExpensiveOnBitwise-ok (param $0 i32) (param $1 i32) (result i32)
 ;; CHECK:  (if
 ;; CHECK:   (i32.eqz
 ;; CHECK:    (i32.and
 ;; CHECK:     (i32.lt_s
 ;; CHECK:      (i32.and
 ;; CHECK:       (i32.shr_s
 ;; CHECK:        (i32.shl
 ;; CHECK:         (i32.add
 ;; CHECK:          (local.get $0)
 ;; CHECK:          (i32.const -1)
 ;; CHECK:         )
 ;; CHECK:         (i32.const 24)
 ;; CHECK:        )
 ;; CHECK:        (i32.const 24)
 ;; CHECK:       )
 ;; CHECK:       (i32.const 255)
 ;; CHECK:      )
 ;; CHECK:      (i32.const 3)
 ;; CHECK:     )
 ;; CHECK:     (i32.ne
 ;; CHECK:      (local.tee $1
 ;; CHECK:       (i32.const 0)
 ;; CHECK:      )
 ;; CHECK:      (i32.const 0)
 ;; CHECK:     )
 ;; CHECK:    )
 ;; CHECK:   )
 ;; CHECK:   (return
 ;; CHECK:    (local.get $0)
 ;; CHECK:   )
 ;; CHECK:  )
 ;; CHECK:  (return
 ;; CHECK:   (local.get $1)
 ;; CHECK:  )
 ;; CHECK: )
  (func $invalidate-conditionalizeExpensiveOnBitwise-ok (param $0 i32) (param $1 i32) (result i32)
   (if
    (i32.eqz
     (i32.and
      (i32.lt_s
       (i32.and
        (i32.shr_s
         (i32.shl
          (i32.add
           (local.get $0) ;; no conflict
           (i32.const -1)
          )
          (i32.const 24)
         )
         (i32.const 24)
        )
        (i32.const 255)
       )
       (i32.const 3)
      )
      (i32.ne
       (local.tee $1
        (i32.const 0)
       )
       (i32.const 0)
      )
     )
    )
    (return (local.get $0))
   )
   (return (local.get $1))
  )

 ;; CHECK: (func $conditionalize-if-type-change (result f64)
 ;; CHECK:  (local $0 i32)
 ;; CHECK:  (drop
 ;; CHECK:   (loop $label$1 (result f32)
 ;; CHECK:    (block $label$2 (result f32)
 ;; CHECK:     (drop
 ;; CHECK:      (block $label$3 (result f32)
 ;; CHECK:       (br_if $label$1
 ;; CHECK:        (i32.or
 ;; CHECK:         (f32.gt
 ;; CHECK:          (br_if $label$3
 ;; CHECK:           (f32.const 1)
 ;; CHECK:           (local.get $0)
 ;; CHECK:          )
 ;; CHECK:          (br $label$2
 ;; CHECK:           (f32.const 71)
 ;; CHECK:          )
 ;; CHECK:         )
 ;; CHECK:         (i64.eqz
 ;; CHECK:          (select
 ;; CHECK:           (i64.const 58)
 ;; CHECK:           (i64.const -982757)
 ;; CHECK:           (i64.eqz
 ;; CHECK:            (i64.const 0)
 ;; CHECK:           )
 ;; CHECK:          )
 ;; CHECK:         )
 ;; CHECK:        )
 ;; CHECK:       )
 ;; CHECK:      )
 ;; CHECK:     )
 ;; CHECK:     (f32.const 1)
 ;; CHECK:    )
 ;; CHECK:   )
 ;; CHECK:  )
 ;; CHECK:  (f64.const -nan:0xfffffffffffff)
 ;; CHECK: )
 (func $conditionalize-if-type-change (result f64)
  (local $0 i32)
  (drop
   (loop $label$1 (result f32)
    (block $label$2 (result f32)
     (drop
      (block $label$3 (result f32)
       (br_if $label$1
        (i32.or ;; this turns into an if, but then the if might not be unreachable
         (f32.gt
          (br_if $label$3
           (f32.const 1)
           (local.get $0)
          )
          (br $label$2
           (f32.const 71)
          )
         )
         (i64.eqz
          (select
           (i64.const 58)
           (i64.const -982757)
           (i64.eqz
            (i64.const 0)
           )
          )
         )
        )
       )
      )
     )
     (f32.const 1)
    )
   )
  )
  (f64.const -nan:0xfffffffffffff)
 )
 ;; CHECK: (func $optimize-bulk-memory-copy (param $dst i32) (param $src i32) (param $sz i32)
 ;; CHECK:  (memory.copy
 ;; CHECK:   (local.get $dst)
 ;; CHECK:   (local.get $dst)
 ;; CHECK:   (local.get $sz)
 ;; CHECK:  )
 ;; CHECK:  (memory.copy
 ;; CHECK:   (local.get $dst)
 ;; CHECK:   (local.get $src)
 ;; CHECK:   (i32.const 0)
 ;; CHECK:  )
 ;; CHECK: )
 (func $optimize-bulk-memory-copy (param $dst i32) (param $src i32) (param $sz i32)
  (memory.copy  ;; nop
    (local.get $dst)
    (local.get $dst)
    (local.get $sz)
  )

  (memory.copy  ;; nop
    (local.get $dst)
    (local.get $src)
    (i32.const 0)
  )
 )
)
