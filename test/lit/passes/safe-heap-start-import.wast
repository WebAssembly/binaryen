;; NOTE: Assertions have been generated by update_lit_checks.py and should not be edited.
;; RUN: wasm-opt %s --safe-heap --enable-threads --enable-simd -S -o - | filecheck %s

;; Test that safe-heap does not crash when the start function calls an imported
;; function. The findCalledFunctions helper transitively walks all called
;; functions from the start, and must skip imported functions which have no body.

(module
  ;; CHECK:      (import "env" "some_import" (func $import))
  (import "env" "some_import" (func $import))
  ;; CHECK:      (import "env" "emscripten_get_sbrk_ptr" (func $emscripten_get_sbrk_ptr (result i32)))
  (import "env" "emscripten_get_sbrk_ptr" (func $emscripten_get_sbrk_ptr (result i32)))
  (memory 1 1 shared)

  ;; CHECK:      (start $start)

  ;; CHECK:      (func $start
  ;; CHECK-NEXT:  (call $import)
  ;; CHECK-NEXT: )
  (func $start
    ;; The start function calls an imported function. Previously this would
    ;; crash because findCalledFunctions would try to walk the null body of
    ;; the imported function.
    (call $import)
  )

  (start $start)
)
