;; NOTE: Assertions have been generated by update_lit_checks.py and should not be edited.
;; RUN: wasm-opt %s --optimize-casts --enable-gc -S -o - | filecheck %s

(module
  (type $A (struct))

  (func $not-past-call (param $x (ref struct))
    (drop
      (ref.cast $A
        (local.get $x)
      )
    )
    ;; The call in the middle does not stop us from helping the last get, since
    ;; EH is not enabled.
    (drop
      (call $get)
    )
    (drop
      (local.get $x)
    )
  )

  (func $not-past-call (param $x (ref struct))
    (drop
      (ref.cast $A
        (local.get $x)
      )
    )
    ;; The call_return in the middle stops us from helping the last get. We
    ;; could still optimize in this case, however, with more precision (since
    ;; after we branch out it doesn't matter what we have below).
    (drop
      (call_return $get
        (ref.null func)
      )
    )
    (drop
      (local.get $x)
    )
  )

  (func $get (result (ref struct))
    ;; Helper for the above.
    (unreachable)
  )
)
