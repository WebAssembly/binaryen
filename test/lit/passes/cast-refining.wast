;; NOTE: Assertions have been generated by update_lit_checks.py and should not be edited.

;; Run in both TNH and non-TNH mode. This pass should do nothing atm in non-TNH.

;; foreach %s %t wasm-opt --cast-refining --traps-never-happen -all -S -o - | filecheck %s --check-prefix=YESTNH
;; foreach %s %t wasm-opt --cast-refining                      -all -S -o - | filecheck %s --check-prefix=NO_TNH

;; $A :> $B :> $C :> $D1,
;;                   $D2
;;
;; $A and $C have no struct.news, so we can optimize casts of them in theory.
;; But for $C the two children prevent that.
(module
  (type $A (struct))

  (type $B (struct_subtype $A))

  (type $C (struct_subtype $B))

  (type $D1 (struct_subtype $C))

  (type $D2 (struct_subtype $C))

  (global $global anyref (struct.new $B))

  (func $new (param $x anyref)
    (drop
      (struct.new $D1
    )
    (drop
      (struct.new $D2
    )
  )

  (func $ref.cast
    ;; List out all possible casts for comprehensiveness. For other instructions
    ;; we are more focused, below.
    (drop
      (ref.cast $A
        (local.get $x)
      )
    )
    (drop
      (ref.cast $B
        (local.get $x)
      )
    )
    (drop
      (ref.cast $C
        (local.get $x)
      )
    )
    (drop
      (ref.cast $D1
        (local.get $x)
      )
    )
    (drop
      (ref.cast $D2
        (local.get $x)
      )
    )
  )

  (func $ref.test
    (drop
      (ref.test $A
        (local.get $x)
      )
    )
  )

  (func $br_on
    (drop
      (block (result anyref)
        (drop
          (br_on_cast $A
            (local.get $x)
          )
        )
      )
    )
  )
)
